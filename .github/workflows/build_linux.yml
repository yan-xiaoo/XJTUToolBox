name: Build & Release Linux

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

env:
  PYTHONUTF8: 1

permissions:
  contents: write

jobs:
  # ==========================================
  # 任务 1：构建 x86_64 架构的 Linux 包
  # ==========================================
  build-linux-x86_64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install UV
        uses: astral-sh/setup-uv@v5

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm libarchive-tools zstd file libxml2-dev libxslt-dev
          sudo gem install fpm

      - name: Install dependencies
        run: uv sync --locked --all-extras --dev

      - name: Patch Application
        run: |
          python -c "
          import os
          def patch(path, code):
              if os.path.exists(path):
                  with open(path, 'r', encoding='utf-8') as f: content = f.read()
                  with open(path, 'w', encoding='utf-8') as f: f.write(code + '\n' + content)
          
          patch('app/utils/account.py', 'import keyring, keyring.core\n_orig_get_password = keyring.core.get_password\ndef _safe_get_password(*args, **kwargs):\n    try: return _orig_get_password(*args, **kwargs)\n    except Exception: return None\nkeyring.core.get_password = keyring.get_password = _safe_get_password')
          
          patch('app.py', 'import os, sys, sqlite3\nif getattr(sys, \"frozen\", False) and sys.platform.startswith(\"linux\"):\n    if \"LD_LIBRARY_PATH\" in os.environ: os.environ[\"LD_LIBRARY_PATH\"] = os.environ.get(\"LD_LIBRARY_PATH_ORIG\", \"\")\n_orig_connect = sqlite3.connect\ndef _safe_connect(database, *args, **kwargs):\n    try:\n        db_str = str(database)\n        if db_str and db_str != \":memory:\" and not db_str.startswith(\"file:\"):\n            user_dir = os.path.expanduser(\"~/.config/XJTUToolbox\")\n            os.makedirs(user_dir, exist_ok=True)\n            database = os.path.join(user_dir, os.path.basename(db_str))\n    except Exception: pass\n    return _orig_connect(database, *args, **kwargs)\nsqlite3.connect = _safe_connect')
          "

      - name: Extract Icon
        run: |
          uv pip install Pillow
          uv run python -c "from PIL import Image; import os; os.makedirs('dist/wrapper/usr/share/pixmaps', exist_ok=True); Image.open('assets/icons/main_icon.ico').save('dist/wrapper/usr/share/pixmaps/xjtutoolbox.png', format='PNG')"

      - name: Build Application
        run: uv run build.py

      - name: Create Packages (x86_64)
        run: |
          cd dist/
          VERSION=${GITHUB_REF_NAME#v}
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then VERSION="1.0.0"; fi
          mkdir -p wrapper/usr/bin wrapper/usr/share/applications
          echo -e '#!/bin/sh\nUSER_DIR="$HOME/.config/XJTUToolbox"\nmkdir -p "$USER_DIR"\ncd "$USER_DIR" || exit 1\nexec /opt/XJTUToolbox/XJTUToolbox "$@"' > wrapper/usr/bin/xjtutoolbox
          chmod +x wrapper/usr/bin/xjtutoolbox
          echo -e '[Desktop Entry]\nName=XJTUToolbox\nExec=xjtutoolbox\nIcon=xjtutoolbox\nType=Application\nCategories=Utility;\nTerminal=false' > wrapper/usr/share/applications/xjtutoolbox.desktop
          
          fpm -s dir -t deb -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-amd64.deb XJTUToolbox=/opt/ wrapper/usr/bin/xjtutoolbox=/usr/bin/xjtutoolbox wrapper/usr/share/pixmaps/xjtutoolbox.png=/usr/share/pixmaps/xjtutoolbox.png wrapper/usr/share/applications/xjtutoolbox.desktop=/usr/share/applications/xjtutoolbox.desktop
          fpm -s dir -t rpm -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-x86_64.rpm XJTUToolbox=/opt/ wrapper/usr/bin/xjtutoolbox=/usr/bin/xjtutoolbox wrapper/usr/share/pixmaps/xjtutoolbox.png=/usr/share/pixmaps/xjtutoolbox.png wrapper/usr/share/applications/xjtutoolbox.desktop=/usr/share/applications/xjtutoolbox.desktop
          fpm -s dir -t pacman -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-x86_64.pkg.tar.zst XJTUToolbox=/opt/ wrapper/usr/bin/xjtutoolbox=/usr/bin/xjtutoolbox wrapper/usr/share/pixmaps/xjtutoolbox.png=/usr/share/pixmaps/xjtutoolbox.png wrapper/usr/share/applications/xjtutoolbox.desktop=/usr/share/applications/xjtutoolbox.desktop

      - name: Create AppImage (x86_64)
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          mkdir -p AppDir/usr/bin
          cp -r dist/XJTUToolbox/* AppDir/usr/bin/
          echo -e '#!/bin/sh\nUSER_DIR="$HOME/.config/XJTUToolbox"\nmkdir -p "$USER_DIR"\ncd "$USER_DIR" || exit 1\nHERE="$(dirname "$(readlink -f "${0}")")"\nexec "${HERE}/usr/bin/XJTUToolbox" "$@"' > AppDir/AppRun
          chmod +x AppDir/AppRun
          cp dist/wrapper/usr/share/applications/xjtutoolbox.desktop AppDir/
          cp dist/wrapper/usr/share/pixmaps/xjtutoolbox.png AppDir/
          cp dist/wrapper/usr/share/pixmaps/xjtutoolbox.png AppDir/.DirIcon
          ./appimagetool --appimage-extract-and-run AppDir dist/XJTUToolbox-linux-x86_64.AppImage

      - name: Upload & Release (x86_64)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/XJTUToolbox-linux-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # 任务 2：构建 ARM64 架构的 Linux 包 (QEMU)
  # ==========================================
  build-linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build ARM64 via QEMU
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          install: |
            apt-get update
            apt-get install -y curl ruby ruby-dev rubygems build-essential rpm libarchive-tools zstd file libxml2-dev libxslt-dev wget python3-pyqt5 python3-pip python3-venv python3-dev squashfs-tools
            gem install fpm
          env: |
            GITHUB_REF_NAME: ${{ github.ref_name }}
          run: |
            echo "::group::1. 依赖同步与补全纯 Python 库"
            curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR="/usr/local/bin" sh
            uv venv --python python3 --system-site-packages .venv
            rm -f uv.lock || true
            uv sync --all-extras --dev
            
            # 使用 --no-deps 安装 UI 库，严防死守拉取 PyQt5 源码引发的 qmake 报错
            uv pip install --no-deps "pyqt-fluent-widgets~=1.8.7" "pyqt5-frameless-window~=0.7.4" "darkdetect"
            echo "::endgroup::"

            echo "::group::2. 注入补丁与转换图标"
            uv run python -c "
            import os
            def patch(path, code):
                if os.path.exists(path):
                    with open(path, 'r', encoding='utf-8') as f: content = f.read()
                    with open(path, 'w', encoding='utf-8') as f: f.write(code + '\n' + content)
            patch('app/utils/account.py', 'import keyring, keyring.core\n_orig_get_password = keyring.core.get_password\ndef _safe_get_password(*args, **kwargs):\n    try: return _orig_get_password(*args, **kwargs)\n    except Exception: return None\nkeyring.core.get_password = keyring.get_password = _safe_get_password')
            patch('app.py', 'import os, sys, sqlite3\nif getattr(sys, \"frozen\", False) and sys.platform.startswith(\"linux\"):\n    if \"LD_LIBRARY_PATH\" in os.environ: os.environ[\"LD_LIBRARY_PATH\"] = os.environ.get(\"LD_LIBRARY_PATH_ORIG\", \"\")\n_orig_connect = sqlite3.connect\ndef _safe_connect(database, *args, **kwargs):\n    try:\n        db_str = str(database)\n        if db_str and db_str != \":memory:\" and not db_str.startswith(\"file:\"):\n            user_dir = os.path.expanduser(\"~/.config/XJTUToolbox\")\n            os.makedirs(user_dir, exist_ok=True)\n            database = os.path.join(user_dir, os.path.basename(db_str))\n    except Exception: pass\n    return _orig_connect(database, *args, **kwargs)\nsqlite3.connect = _safe_connect')
            "
            uv pip install Pillow
            uv run python -c "from PIL import Image; import os; os.makedirs('dist/wrapper/usr/share/pixmaps', exist_ok=True); Image.open('assets/icons/main_icon.ico').save('dist/wrapper/usr/share/pixmaps/xjtutoolbox.png', format='PNG')"
            echo "::endgroup::"

            echo "::group::3. 执行构建与打包 (ARM64)"
            uv run build.py
            cd dist/
            VERSION=${GITHUB_REF_NAME#v}
            [ ! \"\$VERSION\" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ] && VERSION=\"1.0.0\"
            mkdir -p wrapper/usr/bin wrapper/usr/share/applications
            echo -e '#!/bin/sh\nUSER_DIR=\"\$HOME/.config/XJTUToolbox\"\nmkdir -p \"\$USER_DIR\"\ncd \"\$USER_DIR\" || exit 1\nexec /opt/XJTUToolbox/XJTUToolbox \"\$@\"' > wrapper/usr/bin/xjtutoolbox
            chmod +x wrapper/usr/bin/xjtutoolbox
            echo -e '[Desktop Entry]\nName=XJTUToolbox\nExec=xjtutoolbox\nIcon=xjtutoolbox\nType=Application\nCategories=Utility;\nTerminal=false' > wrapper/usr/share/applications/xjtutoolbox.desktop
            
            fpm -a arm64 -s dir -t deb -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-arm64.deb XJTUToolbox=/opt/ wrapper/usr/bin/xjtutoolbox=/usr/bin/xjtutoolbox wrapper/usr/share/pixmaps/xjtutoolbox.png=/usr/share/pixmaps/xjtutoolbox.png wrapper/usr/share/applications/xjtutoolbox.desktop=/usr/share/applications/xjtutoolbox.desktop
            fpm -a arm64 -s dir -t rpm -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-arm64.rpm XJTUToolbox=/opt/ wrapper/usr/bin/xjtutoolbox=/usr/bin/xjtutoolbox wrapper/usr/share/pixmaps/xjtutoolbox.png=/usr/share/pixmaps/xjtutoolbox.png wrapper/usr/share/applications/xjtutoolbox.desktop=/usr/share/applications/xjtutoolbox.desktop
            fpm -a arm64 -s dir -t pacman -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-arm64.pkg.tar.zst XJTUToolbox=/opt/ wrapper/usr/bin/xjtutoolbox=/usr/bin/xjtutoolbox wrapper/usr/share/pixmaps/xjtutoolbox.png=/usr/share/pixmaps/xjtutoolbox.png wrapper/usr/share/applications/xjtutoolbox.desktop=/usr/share/applications/xjtutoolbox.desktop
            echo "::endgroup::"

            echo "::group::4. 打包 ARM64 AppImage"
            wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
            chmod +x appimagetool
            mkdir -p AppDir/usr/bin
            cp -r XJTUToolbox/* AppDir/usr/bin/
            echo -e '#!/bin/sh\nUSER_DIR=\"\$HOME/.config/XJTUToolbox\"\nmkdir -p \"\$USER_DIR\"\ncd \"\$USER_DIR\" || exit 1\nHERE=\"\$(dirname \"\$(readlink -f \"\${0}\")\")\"\nexec \"\${HERE}/usr/bin/XJTUToolbox\" \"\$@\"' > AppDir/AppRun
            chmod +x AppDir/AppRun
            cp wrapper/usr/share/applications/xjtutoolbox.desktop AppDir/
            cp wrapper/usr/share/pixmaps/xjtutoolbox.png AppDir/
            cp wrapper/usr/share/pixmaps/xjtutoolbox.png AppDir/.DirIcon
            
            # 使用解压神器当场强解，绕过 QEMU Exec format error
            apt-get install -y squashfs-tools
            unsquashfs -f -d squashfs-root appimagetool
            rm -f squashfs-root/usr/lib/libreadline.so* || true
            ARCH=arm64 ./squashfs-root/AppRun AppDir XJTUToolbox-linux-arm64.AppImage
            echo "::endgroup::"

      - name: Release ARM64
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/XJTUToolbox-linux-arm64.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}