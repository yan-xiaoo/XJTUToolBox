name: Build & Release Linux

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

env:
  PYTHONUTF8: 1

permissions:
  contents: write

jobs:
  build-linux:
    name: build-linux-native
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Install UV
        uses: astral-sh/setup-uv@v5
        
      - name: Install Packaging Tools (fpm)
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm file
          sudo gem install fpm

      - name: Prepare Package Root
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          if [[ "$VERSION" == "" || "$VERSION" == "main" ]]; then VERSION="1.0.0"; fi
          echo "PKG_VERSION=$VERSION" >> $GITHUB_ENV

          PKG_DIR=$(pwd)/dist/pkg-root
          mkdir -p $PKG_DIR/opt/xjtutoolbox
          mkdir -p $PKG_DIR/usr/bin
          mkdir -p $PKG_DIR/usr/share/applications
          mkdir -p $PKG_DIR/usr/share/pixmaps

          # 1. 使用 rsync 拷贝源码，提前排除 dist 和无关文件，避免 cp 产生的死循环报错
          rsync -a --exclude='dist' --exclude='.git' --exclude='.github' --exclude='docs' --exclude='uv.lock' ./ $PKG_DIR/opt/xjtutoolbox/

          # 2. 数据库路径热修复 (无缝解决权限问题)
          DB_FILE="$PKG_DIR/opt/xjtutoolbox/schedule/schedule_database.py"
          if [ -f "$DB_FILE" ]; then
            sed -i "s|'schedule.db'|__import__('os').path.expanduser('~/.xjtutoolbox_schedule.db')|g" "$DB_FILE"
            sed -i 's|"schedule.db"|__import__("os").path.expanduser("~/.xjtutoolbox_schedule.db")|g' "$DB_FILE"
          fi

      - name: Resolve Independent Dependencies (Libs)
        run: |
          PKG_DIR=$(pwd)/dist/pkg-root
          
          # 使用 uv 将所有依赖安装到独立的 libs 目录中
          uv pip install --python $(which python3) --target $PKG_DIR/opt/xjtutoolbox/libs -r pyproject.toml
          
          # 【核心魔法】删除 libs 里的 PyQt5 及其依赖，强迫程序运行时回退使用系统的 python3-pyqt5
          # 这样既保证了 PyQt-Fluent-Widgets 等纯 Python 库正常工作，又极大地减小了包体积
          rm -rf $PKG_DIR/opt/xjtutoolbox/libs/PyQt5*
          
          # 清理缓存文件
          find $PKG_DIR/opt/xjtutoolbox -name "*.pyc" -delete
          find $PKG_DIR/opt/xjtutoolbox -name "__pycache__" -delete

      - name: Create Launcher & Desktop Integration
        run: |
          PKG_DIR=$(pwd)/dist/pkg-root
          
          # 创建启动脚本 (注入 PYTHONPATH 实现依赖隔离)
          cat <<EOF > $PKG_DIR/usr/bin/xjtutoolbox
          #!/bin/sh
          export PYTHONDONTWRITEBYTECODE=1
          export PYTHONPATH=/opt/xjtutoolbox/libs:\$PYTHONPATH
          cd /opt/xjtutoolbox
          exec python3 app.py "\$@"
          EOF
          chmod +x $PKG_DIR/usr/bin/xjtutoolbox

          # 生成 Desktop 文件
          cat <<EOF > $PKG_DIR/usr/share/applications/xjtutoolbox.desktop
          [Desktop Entry]
          Name=XJTUToolBox
          GenericName=XJTU Toolkit
          Comment=西安交通大学一站式校园服务工具
          Exec=xjtutoolbox
          Icon=xjtutoolbox
          Type=Application
          Terminal=false
          Categories=Utility;Education;Qt;
          StartupNotify=true
          StartupWMClass=app.py
          EOF

          # 图标占位符 (如果你有 assets/logo.png 请替换为拷贝命令)
          echo '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="50" fill="#007bff"/></svg>' > $PKG_DIR/usr/share/pixmaps/xjtutoolbox.svg

      - name: Package with FPM
        run: |
          cd dist
          
          # 打包 .deb (适配 Debian/Ubuntu，依赖系统级 python3-pyqt5)
          fpm -s dir -t deb -n xjtutoolbox -v ${{ env.PKG_VERSION }} \
              -d "python3" -d "python3-pyqt5" \
              -C pkg-root -p XJTUToolbox-linux-x86_64.deb .
              
          # 打包 .rpm (适配 Fedora/CentOS/openSUSE，依赖系统级 python3-qt5)
          fpm -s dir -t rpm -n xjtutoolbox -v ${{ env.PKG_VERSION }} \
              -d "python3" -d "python3-qt5" \
              -C pkg-root -p XJTUToolbox-linux-x86_64.rpm .

      - name: Cleanup
        run: |
          find dist -maxdepth 1 -type d -name "pkg-root" -exec rm -rf {} +

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: XJTUToolbox-linux-native-packages
          path: ./dist/XJTUToolbox-linux-x86_64.*

      - name: Prerelease app
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: XJTUToolbox ${{ github.ref_name }}
          prerelease: true
          files: "./dist/XJTUToolbox-linux-x86_64.*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}