name: Build & Release Linux

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

env:
  PYTHONUTF8: 1

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install UV
        uses: astral-sh/setup-uv@v5

      # 1. 安装 Linux 打包所需的系统依赖 (新增了 libxml2-dev 和 libxslt-dev 以解决 lxml 报错)
      - name: Install System Dependencies for Packaging
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm libarchive-tools zstd file libxml2-dev libxslt-dev
          sudo gem install fpm

      # 2. 安装项目依赖
      - name: Install dependencies
        run: uv sync --locked --all-extras --dev

      # 3. 运行项目自身的构建脚本
      - name: Build Application
        run: uv run build.py

      # 4. 使用 fpm 生成 deb, rpm, pacman 安装包
      - name: Create Linux Packages (DEB, RPM, Pacman)
        run: |
          cd dist/
          # 提取版本号，例如从 refs/tags/v1.0.0 提取 1.0.0 作为包版本
          VERSION=${GITHUB_REF_NAME#v}
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            VERSION="1.0.0" # 手动触发时的默认版本
          fi
          
          # fpm 会将 dist/XJTUToolbox 映射到安装后的 /opt/XJTUToolbox 目录
          # 生成 Debian/Ubuntu (apt) 包
          fpm -s dir -t deb -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-amd64.deb XJTUToolbox=/opt/
          
          # 生成 RedHat/CentOS (rpm) 包
          fpm -s dir -t rpm -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-x86_64.rpm XJTUToolbox=/opt/
          
          # 生成 Arch Linux (pacman) 包
          fpm -s dir -t pacman -n xjtutoolbox -v $VERSION -p XJTUToolbox-linux-x86_64.pkg.tar.zst XJTUToolbox=/opt/

      # 5. 生成 AppImage
      - name: Create AppImage
        run: |
          # 下载官方打包工具
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool
          
          # 准备 AppDir 目录结构
          mkdir -p AppDir/usr/bin
          cp -r dist/XJTUToolbox/* AppDir/usr/bin/
          
          # 创建 AppRun 启动脚本
          cat <<'EOF' > AppDir/AppRun
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "${0}")")"
          exec "${HERE}/usr/bin/XJTUToolbox" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # 创建桌面快捷方式配置文件 (.desktop)
          cat <<EOF > AppDir/xjtutoolbox.desktop
          [Desktop Entry]
          Name=XJTUToolbox
          Exec=XJTUToolbox
          Icon=xjtutoolbox
          Type=Application
          Categories=Utility;
          EOF
          
          # 创建一个默认的占位图标
          echo '<svg width="256" height="256" xmlns="http://www.w3.org/2000/svg"><rect width="256" height="256" fill="#007ACC"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="48" font-family="Arial">XJTU</text></svg>' > AppDir/xjtutoolbox.svg
          
          # 执行打包
          ./appimagetool --appimage-extract-and-run AppDir dist/XJTUToolbox-linux-x86_64.AppImage

      # 6. 上传 Artifacts
      - name: Upload Artifacts (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: XJTUToolbox-linux
          path: |
            ./dist/XJTUToolbox-linux-amd64.deb
            ./dist/XJTUToolbox-linux-x86_64.rpm
            ./dist/XJTUToolbox-linux-x86_64.pkg.tar.zst
            ./dist/XJTUToolbox-linux-x86_64.AppImage

      # 7. 发布至 Github Releases
      - name: Release Linux
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: XJTUToolbox ${{ github.ref_name }}
          prerelease: true
          files: |
            ./dist/XJTUToolbox-linux-amd64.deb
            ./dist/XJTUToolbox-linux-x86_64.rpm
            ./dist/XJTUToolbox-linux-x86_64.pkg.tar.zst
            ./dist/XJTUToolbox-linux-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}