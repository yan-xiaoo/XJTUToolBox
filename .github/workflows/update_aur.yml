name: Update AUR Packages

on:
  # 触发条件 1：全自动。当 Release 正式发布或修改时自动触发
  release:
    types: [released, published, edited]
    
  # 触发条件 2：纯手动。让你随时可以在 Actions 面板里看到那个 "Run workflow" 按钮！
  workflow_dispatch:
    inputs:
      tag_name:
        description: '手动触发时，请输入你要发布的版本号 (如: v1.2.3)'
        required: true
        type: string

jobs:
  update-aur:
    # 拦截器：允许手动强制执行；如果是自动触发，则要求必须是非 Prerelease (正式版) 才执行
    if: github.event_name == 'workflow_dispatch' || github.event.release.prerelease == false
    runs-on: ubuntu-latest
    
    # 智能环境变量：自动分辨此次运行是手动还是自动，提取正确的版本号
    env:
      TARGET_TAG: ${{ github.event.release.tag_name || inputs.tag_name }}
    
    steps:
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4

      - name: Wait for Release Assets to be Ready
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting for compiled assets to appear on release ${{ env.TARGET_TAG }}..."
          
          # 循环检查最多 30 次，每次间隔 30 秒（总计等待 15 分钟）
          for i in {1..30}; do
            ASSETS=$(gh release view "${{ env.TARGET_TAG }}" --json assets -q '.assets[].name' || echo "")
            if echo "$ASSETS" | grep -q "linux-x86_64.pkg.tar.zst" && echo "$ASSETS" | grep -q "linux-arm64.pkg.tar.zst"; then
              echo "✅ All required assets found! Proceeding with AUR update."
              exit 0
            fi
            echo "⏳ Assets not fully ready yet. Waiting 30 seconds... ($i/30)"
            sleep 30
          done
          
          echo "❌ Timeout waiting for release assets."
          exit 1

      - name: Prepare PKGBUILD Versions
        run: |
          VERSION="${{ env.TARGET_TAG }}"
          VERSION="${VERSION#v}" # 去除 'v' 前缀
          
          echo "Updating PKGBUILDs to version $VERSION"
          
          # 直接在 Ubuntu 环境下更新版本号
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/xjtutoolbox/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" aur/xjtutoolbox/PKGBUILD
          
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/xjtutoolbox-bin/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" aur/xjtutoolbox-bin/PKGBUILD

      - name: Generate .SRCINFO and Checksums (via Arch Container)
        run: |
          # 临时拉起 Arch 容器，执行完毕立刻销毁，保持环境纯净
          docker run --rm -v ${{ github.workspace }}:/work archlinux:base-devel bash -c "
            pacman -Syu --noconfirm pacman-contrib sudo git
            
            # 创建一个普通用户来运行 makepkg
            useradd -m builder
            echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            chown -R builder:builder /work
            
            echo 'Processing xjtutoolbox (Source Build)...'
            cd /work/aur/xjtutoolbox
            su builder -c 'updpkgsums'
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
            
            echo 'Processing xjtutoolbox-bin (Pre-compiled)...'
            cd /work/aur/xjtutoolbox-bin
            su builder -c 'updpkgsums'
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
          "

      - name: Publish to AUR (xjtutoolbox)
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: xjtutoolbox
          pkgbuild: ./aur/xjtutoolbox/PKGBUILD
          commit_username: "github-actions[bot]"
          commit_email: "github-actions[bot]@users.noreply.github.com"
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Auto-update to version ${{ env.TARGET_TAG }}"

      - name: Publish to AUR (xjtutoolbox-bin)
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: xjtutoolbox-bin
          pkgbuild: ./aur/xjtutoolbox-bin/PKGBUILD
          commit_username: "github-actions[bot]"
          commit_email: "github-actions[bot]@users.noreply.github.com"
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Auto-update to version ${{ env.TARGET_TAG }}"