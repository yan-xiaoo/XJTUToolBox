name: Update AUR Packages

on:
  # 当 Release 被发布，或者从预发布改为正式发布时触发
  release:
    types: [published, edited]

jobs:
  update-aur:
    # 核心拦截：如果是 Prerelease 预发布版，直接跳过此任务
    if: github.event.release.prerelease == false
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitHub Repository
        uses: actions/checkout@v4

      # 解决时序冲突的终极武器：等待 build_linux 的产物上传完毕
      - name: Wait for Release Assets to be Ready
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Waiting for compiled assets to appear on release $TAG..."
          
          # 循环检查最多 30 次，每次间隔 30 秒（总计等待 15 分钟）
          for i in {1..30}; do
            ASSETS=$(gh release view "$TAG" --json assets -q '.assets[].name' || echo "")
            if echo "$ASSETS" | grep -q "linux-x86_64.pkg.tar.zst" && echo "$ASSETS" | grep -q "linux-arm64.pkg.tar.zst"; then
              echo "✅ All required assets found! Proceeding with AUR update."
              exit 0
            fi
            echo "⏳ Assets not fully ready yet. Waiting 30 seconds... ($i/30)"
            sleep 30
          done
          
          echo "❌ Timeout waiting for release assets."
          exit 1

      - name: Prepare PKGBUILD Versions
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}" # 去除 'v' 前缀
          
          echo "Updating PKGBUILDs to version $VERSION"
          
          # 直接在 Ubuntu 环境下更新版本号
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/xjtutoolbox/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" aur/xjtutoolbox/PKGBUILD
          
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" aur/xjtutoolbox-bin/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" aur/xjtutoolbox-bin/PKGBUILD

      - name: Generate .SRCINFO and Checksums (via Arch Container)
        run: |
          # 临时拉起 Arch 容器，执行完毕立刻销毁，保持环境纯净
          docker run --rm -v ${{ github.workspace }}:/work archlinux:base-devel bash -c "
            pacman -Syu --noconfirm pacman-contrib sudo git
            
            # 创建一个普通用户来运行 makepkg
            useradd -m builder
            echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
            chown -R builder:builder /work
            
            echo 'Processing xjtutoolbox (Source Build)...'
            cd /work/aur/xjtutoolbox
            su builder -c 'updpkgsums'
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
            
            echo 'Processing xjtutoolbox-bin (Pre-compiled)...'
            cd /work/aur/xjtutoolbox-bin
            su builder -c 'updpkgsums'
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
          "

      - name: Publish to AUR (xjtutoolbox)
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: xjtutoolbox
          pkgbuild: ./aur/xjtutoolbox/PKGBUILD
          commit_username: "github-actions[bot]"
          commit_email: "github-actions[bot]@users.noreply.github.com"
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Auto-update to version ${{ github.event.release.tag_name }}"

      - name: Publish to AUR (xjtutoolbox-bin)
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: xjtutoolbox-bin
          pkgbuild: ./aur/xjtutoolbox-bin/PKGBUILD
          commit_username: "github-actions[bot]"
          commit_email: "github-actions[bot]@users.noreply.github.com"
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Auto-update to version ${{ github.event.release.tag_name }}"